<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Nextcloud file picker demo</title>
</head>
<body>
	<header>
	</header>
	<main>
		<h1>Nextcloud file picker</h1>
		<h2>This is an example page importing the file picker wrapper. Vue.js is awesome üòÅ but the file picker can be used without it.</h2>
		<p>
			Make sure you installed the
			<a href="https://apps.nextcloud.com/apps/webapppassword">WebAppPassword app</a>
			and added <b id="domainToAuthorize"></b> as allowed origin in WebAppPassword settings.
		</p>
		<p>
			Leave login and password fields empty to let the file picker open an authentication popup and get a temporary app password.
		</p>
		<br>
		<p>
			When these fields are changed, corresponding component update methods are called.
		</p>
		<input id="url" type="text" placeholder="Nextcloud address" value="https://localhost/dev/server">
		<input id="login" type="text" placeholder="login" value="">
		<input id="password" type="password" placeholder="password" value="">
		<input id="color" type="color" value="#0082c9">
		<br><br>
		<button id="selectButton">Custom button to select files</button>
		<p>
			The file picker component is mounted under this line.
		</p>
		<hr>
		<div id="mount_point"></div>
		<hr>
		<p id="results"></p>
	</main>
	<footer style="position: absolute; bottom: 0; right: 0;">
		Generated at Wed Nov  4 16:09:22 UTC 2020
	</footer>
</body>
<script src="../js/filePickerWrapper.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', function(event) {
		document.getElementById('domainToAuthorize').textContent = window.location.protocol + '//' + window.location.host

		// get url values
		const uri = window.location.search.substring(1)
		const params = new URLSearchParams(uri)
		const login = params.get('login')
		if (login) {
			document.getElementById('login').value = login
		}
		const password = params.get('password')
		if (password) {
			document.getElementById('password').value = password
		}
		const url = params.get('url')
		if (url) {
			document.getElementById('url').value = url
		}
		const color = params.get('color')
		if (color) {
			document.getElementById('color').value = '#' + color
		}

		const initialUrl = document.getElementById('url').value
		const initialLogin = document.getElementById('login').value
		const initialPassword = document.getElementById('password').value
		const initialColor = document.getElementById('color').value

		const filepicker = window.createFilePicker('mount_point', initialUrl, initialLogin, initialPassword, initialColor, true)

		// monitor form value change
		document.getElementById('login').addEventListener('input', function(e) {
			filepicker.updateLogin(e.target.value)
		})

		document.getElementById('password').addEventListener('input', function(e) {
			filepicker.updatePassword(e.target.value)
		})

		document.getElementById('url').addEventListener('input', function(e) {
			filepicker.updateUrl(e.target.value)
		})

		document.getElementById('color').addEventListener('change', function(e) {
			filepicker.setMainColor(e.target.value)
		})

		document.getElementById('selectButton').addEventListener('click', function(e) {
			filepicker.getFilesPath()
		})

		// events coming from the file picker
		document.addEventListener('get-files-path', function(e) {
			console.log('no vue, received "get-files-path" event')
			console.debug(e.detail)
			document.getElementById('results').innerHTML = 'Path of selected files:'
			e.detail.forEach((path) => {
				const p = document.createElement('p')
				p.textContent = path
				document.getElementById('results').appendChild(p)
			})
		})

		document.addEventListener('get-save-file-path', function(e) {
			console.log('no vue, received "get-save-file-path" event')
			console.debug(e.detail)
			document.getElementById('results').innerHTML = `Selected target directory: ${e.detail}`
		})

		document.addEventListener('upload-path-link-generated', function(e) {
			console.log('no vue, received "upload-path-link-generated" event')
			console.debug(e.detail)
			document.getElementById('results').innerHTML = `File upload link in ${e.detail.targetDir}:`
			const p = document.createElement('p')
			p.textContent = e.detail.link
			document.getElementById('results').appendChild(p)
		})

		document.addEventListener('get-files-link', function(e) {
			console.log('no vue, received "get-files-link" event')
			console.debug(e.detail)
			document.getElementById('results').innerHTML = 'File links: <br>'
			e.detail.forEach((l) => {
				const a = document.createElement('a')
				a.textContent = l
				a.setAttribute('href', l)
				document.getElementById('results').appendChild(a)
				document.getElementById('results').appendChild(document.createElement('br'))
			})
		})

		document.addEventListener('files-uploaded', function(e) {
			console.log('no vue, received "files-uploaded" event')
			console.debug(e.detail)
			document.getElementById('results').innerHTML = `These files were uploaded in ${e.detail.targetDir}: <br>`
			e.detail.files.forEach((f) => {
				const p = document.createElement('p')
				p.textContent = f.name
				document.getElementById('results').appendChild(p)
			})
		})

		document.addEventListener('files-downloaded', function(e) {
			const files = e.detail
			console.debug('no vue, something was downloaded')
			document.getElementById('results').innerHTML = 'Downloaded files: <br>'
			files.forEach(file => {
				console.debug('File : ' + file.name)
				console.debug(file)
				const reader = new FileReader()
				reader.readAsText(file)
				reader.onload = function() {
					console.debug(reader.result)
					const p = document.createElement('P')
					p.textContent = 'File ' + file.name + ': ' + reader.result.slice(0, 100) + '...'
					document.getElementById('results').appendChild(p)
				}
				reader.onerror = function() {
					console.error('Impossible to read downloaded file')
					console.debug(reader.error)
				}
			})
		})
	})
</script>
